#include "brutal/renderer/debug_draw.h"
#include "brutal/renderer/shader.h"
#include "brutal/renderer/camera.h"
#include "brutal/core/logging.h"
#include <glad/glad.h>
#include <cstdio>
#include <cstdarg>
#include <cstring>

namespace brutal {

static const char* text_vert = R"(
#version 330 core
layout(location = 0) in vec2 a_Pos;
layout(location = 1) in vec2 a_UV;
layout(location = 2) in vec3 a_Color;
uniform vec2 u_Screen;
out vec2 v_UV;
out vec3 v_Color;
void main() {
    vec2 p = a_Pos / u_Screen * 2.0 - 1.0;
    gl_Position = vec4(p.x, -p.y, 0.0, 1.0);
    v_UV = a_UV;
    v_Color = a_Color;
}
)";

static const char* text_frag = R"(
#version 330 core
in vec2 v_UV;
in vec3 v_Color;
uniform sampler2D u_Texture;
out vec4 FragColor;
void main() {
    float a = texture(u_Texture, v_UV).r;
    FragColor = vec4(v_Color, a);
}
)";

static const char* line_vert = R"(
#version 330 core
layout(location = 0) in vec3 a_Pos;
layout(location = 1) in vec3 a_Color;
uniform mat4 u_ViewProj;
out vec3 v_Color;
void main() {
    gl_Position = u_ViewProj * vec4(a_Pos, 1.0);
    v_Color = a_Color;
}
)";

static const char* line_frag = R"(
#version 330 core
in vec3 v_Color;
out vec4 FragColor;
void main() {
    FragColor = vec4(v_Color, 1.0);
}
)";

// Simple 8x8 bitmap font (ASCII 32-126)
static u8 g_font[95][8] = {
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, // space
    {0x18,0x3C,0x3C,0x18,0x18,0x00,0x18,0x00}, // !
    {0x36,0x36,0x00,0x00,0x00,0x00,0x00,0x00}, // "
    {0x36,0x36,0x7F,0x36,0x7F,0x36,0x36,0x00}, // #
    {0x0C,0x3E,0x03,0x1E,0x30,0x1F,0x0C,0x00}, // $
    {0x00,0x63,0x33,0x18,0x0C,0x66,0x63,0x00}, // %
    {0x1C,0x36,0x1C,0x6E,0x3B,0x33,0x6E,0x00}, // &
    {0x06,0x06,0x03,0x00,0x00,0x00,0x00,0x00}, // '
    {0x18,0x0C,0x06,0x06,0x06,0x0C,0x18,0x00}, // (
    {0x06,0x0C,0x18,0x18,0x18,0x0C,0x06,0x00}, // )
    {0x00,0x66,0x3C,0xFF,0x3C,0x66,0x00,0x00}, // *
    {0x00,0x0C,0x0C,0x3F,0x0C,0x0C,0x00,0x00}, // +
    {0x00,0x00,0x00,0x00,0x00,0x0C,0x0C,0x06}, // ,
    {0x00,0x00,0x00,0x3F,0x00,0x00,0x00,0x00}, // -
    {0x00,0x00,0x00,0x00,0x00,0x0C,0x0C,0x00}, // .
    {0x60,0x30,0x18,0x0C,0x06,0x03,0x01,0x00}, // /
    {0x3E,0x63,0x73,0x7B,0x6F,0x67,0x3E,0x00}, // 0
    {0x0C,0x0E,0x0C,0x0C,0x0C,0x0C,0x3F,0x00}, // 1
    {0x1E,0x33,0x30,0x1C,0x06,0x33,0x3F,0x00}, // 2
    {0x1E,0x33,0x30,0x1C,0x30,0x33,0x1E,0x00}, // 3
    {0x38,0x3C,0x36,0x33,0x7F,0x30,0x78,0x00}, // 4
    {0x3F,0x03,0x1F,0x30,0x30,0x33,0x1E,0x00}, // 5
    {0x1C,0x06,0x03,0x1F,0x33,0x33,0x1E,0x00}, // 6
    {0x3F,0x33,0x30,0x18,0x0C,0x0C,0x0C,0x00}, // 7
    {0x1E,0x33,0x33,0x1E,0x33,0x33,0x1E,0x00}, // 8
    {0x1E,0x33,0x33,0x3E,0x30,0x18,0x0E,0x00}, // 9
    {0x00,0x0C,0x0C,0x00,0x00,0x0C,0x0C,0x00}, // :
    {0x00,0x0C,0x0C,0x00,0x00,0x0C,0x0C,0x06}, // ;
    {0x18,0x0C,0x06,0x03,0x06,0x0C,0x18,0x00}, // <
    {0x00,0x00,0x3F,0x00,0x00,0x3F,0x00,0x00}, // =
    {0x06,0x0C,0x18,0x30,0x18,0x0C,0x06,0x00}, // >
    {0x1E,0x33,0x30,0x18,0x0C,0x00,0x0C,0x00}, // ?
    {0x3E,0x63,0x7B,0x7B,0x7B,0x03,0x1E,0x00}, // @
    {0x0C,0x1E,0x33,0x33,0x3F,0x33,0x33,0x00}, // A-Z
    {0x3F,0x66,0x66,0x3E,0x66,0x66,0x3F,0x00},
    {0x3C,0x66,0x03,0x03,0x03,0x66,0x3C,0x00},
    {0x1F,0x36,0x66,0x66,0x66,0x36,0x1F,0x00},
    {0x7F,0x46,0x16,0x1E,0x16,0x46,0x7F,0x00},
    {0x7F,0x46,0x16,0x1E,0x16,0x06,0x0F,0x00},
    {0x3C,0x66,0x03,0x03,0x73,0x66,0x7C,0x00},
    {0x33,0x33,0x33,0x3F,0x33,0x33,0x33,0x00},
    {0x1E,0x0C,0x0C,0x0C,0x0C,0x0C,0x1E,0x00},
    {0x78,0x30,0x30,0x30,0x33,0x33,0x1E,0x00},
    {0x67,0x66,0x36,0x1E,0x36,0x66,0x67,0x00},
    {0x0F,0x06,0x06,0x06,0x46,0x66,0x7F,0x00},
    {0x63,0x77,0x7F,0x7F,0x6B,0x63,0x63,0x00},
    {0x63,0x67,0x6F,0x7B,0x73,0x63,0x63,0x00},
    {0x1C,0x36,0x63,0x63,0x63,0x36,0x1C,0x00},
    {0x3F,0x66,0x66,0x3E,0x06,0x06,0x0F,0x00},
    {0x1E,0x33,0x33,0x33,0x3B,0x1E,0x38,0x00},
    {0x3F,0x66,0x66,0x3E,0x36,0x66,0x67,0x00},
    {0x1E,0x33,0x07,0x0E,0x38,0x33,0x1E,0x00},
    {0x3F,0x2D,0x0C,0x0C,0x0C,0x0C,0x1E,0x00},
    {0x33,0x33,0x33,0x33,0x33,0x33,0x3F,0x00},
    {0x33,0x33,0x33,0x33,0x33,0x1E,0x0C,0x00},
    {0x63,0x63,0x63,0x6B,0x7F,0x77,0x63,0x00},
    {0x63,0x63,0x36,0x1C,0x1C,0x36,0x63,0x00},
    {0x33,0x33,0x33,0x1E,0x0C,0x0C,0x1E,0x00},
    {0x7F,0x63,0x31,0x18,0x4C,0x66,0x7F,0x00},
    {0x1E,0x06,0x06,0x06,0x06,0x06,0x1E,0x00}, // [
    {0x03,0x06,0x0C,0x18,0x30,0x60,0x40,0x00}, // backslash
    {0x1E,0x18,0x18,0x18,0x18,0x18,0x1E,0x00}, // ]
    {0x08,0x1C,0x36,0x63,0x00,0x00,0x00,0x00}, // ^
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF}, // _
    {0x0C,0x0C,0x18,0x00,0x00,0x00,0x00,0x00}, // `
    {0x00,0x00,0x1E,0x30,0x3E,0x33,0x6E,0x00}, // a-z
    {0x07,0x06,0x06,0x3E,0x66,0x66,0x3B,0x00},
    {0x00,0x00,0x1E,0x33,0x03,0x33,0x1E,0x00},
    {0x38,0x30,0x30,0x3E,0x33,0x33,0x6E,0x00},
    {0x00,0x00,0x1E,0x33,0x3F,0x03,0x1E,0x00},
    {0x1C,0x36,0x06,0x0F,0x06,0x06,0x0F,0x00},
    {0x00,0x00,0x6E,0x33,0x33,0x3E,0x30,0x1F},
    {0x07,0x06,0x36,0x6E,0x66,0x66,0x67,0x00},
    {0x0C,0x00,0x0E,0x0C,0x0C,0x0C,0x1E,0x00},
    {0x30,0x00,0x30,0x30,0x30,0x33,0x33,0x1E},
    {0x07,0x06,0x66,0x36,0x1E,0x36,0x67,0x00},
    {0x0E,0x0C,0x0C,0x0C,0x0C,0x0C,0x1E,0x00},
    {0x00,0x00,0x33,0x7F,0x7F,0x6B,0x63,0x00},
    {0x00,0x00,0x1F,0x33,0x33,0x33,0x33,0x00},
    {0x00,0x00,0x1E,0x33,0x33,0x33,0x1E,0x00},
    {0x00,0x00,0x3B,0x66,0x66,0x3E,0x06,0x0F},
    {0x00,0x00,0x6E,0x33,0x33,0x3E,0x30,0x78},
    {0x00,0x00,0x3B,0x6E,0x66,0x06,0x0F,0x00},
    {0x00,0x00,0x3E,0x03,0x1E,0x30,0x1F,0x00},
    {0x08,0x0C,0x3E,0x0C,0x0C,0x2C,0x18,0x00},
    {0x00,0x00,0x33,0x33,0x33,0x33,0x6E,0x00},
    {0x00,0x00,0x33,0x33,0x33,0x1E,0x0C,0x00},
    {0x00,0x00,0x63,0x6B,0x7F,0x7F,0x36,0x00},
    {0x00,0x00,0x63,0x36,0x1C,0x36,0x63,0x00},
    {0x00,0x00,0x33,0x33,0x33,0x3E,0x30,0x1F},
    {0x00,0x00,0x3F,0x19,0x0C,0x26,0x3F,0x00},
    {0x38,0x0C,0x0C,0x07,0x0C,0x0C,0x38,0x00}, // {
    {0x18,0x18,0x18,0x00,0x18,0x18,0x18,0x00}, // |
    {0x07,0x0C,0x0C,0x38,0x0C,0x0C,0x07,0x00}, // }
    {0x6E,0x3B,0x00,0x00,0x00,0x00,0x00,0x00}, // ~
};

struct TextVert { f32 x, y, u, v, r, g, b; };
struct LineVert { f32 x, y, z, r, g, b; };

static Shader g_text_shader;
static u32 g_font_texture;
static u32 g_text_vao, g_text_vbo;
static TextVert g_text_verts[4096];
static u32 g_text_count;
static i32 g_text_loc_screen, g_text_loc_texture;

static Shader g_line_shader;
static u32 g_line_vao, g_line_vbo;
static LineVert g_line_verts[8192];
static u32 g_line_count;
static i32 g_line_loc_viewproj;

bool debug_draw_init() {
    if (!shader_create(&g_text_shader, text_vert, text_frag)) return false;
    g_text_loc_screen = glGetUniformLocation(g_text_shader.program, "u_Screen");
    g_text_loc_texture = glGetUniformLocation(g_text_shader.program, "u_Texture");

    u8 pixels[128 * 128];
    memset(pixels, 0, sizeof(pixels));
    for (int c = 0; c < 95; c++) {
        int cx = (c % 16) * 8, cy = (c / 16) * 8;
        for (int y = 0; y < 8; y++)
            for (int x = 0; x < 8; x++)
                if (g_font[c][y] & (1 << (7 - x)))
                    pixels[(cy + y) * 128 + cx + x] = 255;
    }

    glGenTextures(1, &g_font_texture);
    glBindTexture(GL_TEXTURE_2D, g_font_texture);
    glTexImage2D(GL_TEXTURE_2D, 0, GL_R8, 128, 128, 0, GL_RED, GL_UNSIGNED_BYTE, pixels);
    glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_NEAREST);
    glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_NEAREST);

    glGenVertexArrays(1, &g_text_vao);
    glBindVertexArray(g_text_vao);
    glGenBuffers(1, &g_text_vbo);
    glBindBuffer(GL_ARRAY_BUFFER, g_text_vbo);
    glBufferData(GL_ARRAY_BUFFER, sizeof(g_text_verts), nullptr, GL_DYNAMIC_DRAW);
    glEnableVertexAttribArray(0);
    glVertexAttribPointer(0, 2, GL_FLOAT, GL_FALSE, sizeof(TextVert), (void*)0);
    glEnableVertexAttribArray(1);
    glVertexAttribPointer(1, 2, GL_FLOAT, GL_FALSE, sizeof(TextVert), (void*)8);
    glEnableVertexAttribArray(2);
    glVertexAttribPointer(2, 3, GL_FLOAT, GL_FALSE, sizeof(TextVert), (void*)16);
    glBindVertexArray(0);
    g_text_count = 0;

    if (!shader_create(&g_line_shader, line_vert, line_frag)) return false;
    g_line_loc_viewproj = glGetUniformLocation(g_line_shader.program, "u_ViewProj");

    glGenVertexArrays(1, &g_line_vao);
    glBindVertexArray(g_line_vao);
    glGenBuffers(1, &g_line_vbo);
    glBindBuffer(GL_ARRAY_BUFFER, g_line_vbo);
    glBufferData(GL_ARRAY_BUFFER, sizeof(g_line_verts), nullptr, GL_DYNAMIC_DRAW);
    glEnableVertexAttribArray(0);
    glVertexAttribPointer(0, 3, GL_FLOAT, GL_FALSE, sizeof(LineVert), (void*)0);
    glEnableVertexAttribArray(1);
    glVertexAttribPointer(1, 3, GL_FLOAT, GL_FALSE, sizeof(LineVert), (void*)12);
    glBindVertexArray(0);
    g_line_count = 0;

    return true;
}

void debug_draw_shutdown() {
    glDeleteTextures(1, &g_font_texture);
    glDeleteBuffers(1, &g_text_vbo);
    glDeleteVertexArrays(1, &g_text_vao);
    shader_destroy(&g_text_shader);
    glDeleteBuffers(1, &g_line_vbo);
    glDeleteVertexArrays(1, &g_line_vao);
    shader_destroy(&g_line_shader);
}

static void add_char(f32 x, f32 y, char c, const Vec3& col) {
    if (g_text_count + 6 > 4096) return;
    int ci = c - 32;
    if (ci < 0 || ci >= 95) ci = 0;
    f32 u0 = (ci % 16) * 8.0f / 128.0f, v0 = (ci / 16) * 8.0f / 128.0f;
    f32 u1 = u0 + 8.0f / 128.0f, v1 = v0 + 8.0f / 128.0f;
    TextVert* v = &g_text_verts[g_text_count];
    v[0] = {x, y, u0, v0, col.x, col.y, col.z};
    v[1] = {x+8, y, u1, v0, col.x, col.y, col.z};
    v[2] = {x+8, y+8, u1, v1, col.x, col.y, col.z};
    v[3] = {x, y, u0, v0, col.x, col.y, col.z};
    v[4] = {x+8, y+8, u1, v1, col.x, col.y, col.z};
    v[5] = {x, y+8, u0, v1, col.x, col.y, col.z};
    g_text_count += 6;
}

void debug_text_printf(i32 x, i32 y, const Vec3& col, const char* fmt, ...) {
    char buf[256];
    va_list args;
    va_start(args, fmt);
    vsnprintf(buf, 256, fmt, args);
    va_end(args);
    f32 px = (f32)x;
    for (char* p = buf; *p; p++) { add_char(px, (f32)y, *p, col); px += 8; }
}

void debug_text_flush(i32 sw, i32 sh) {
    if (g_text_count == 0) return;
    glDisable(GL_DEPTH_TEST);
    glEnable(GL_BLEND);
    glBlendFunc(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
    glBindBuffer(GL_ARRAY_BUFFER, g_text_vbo);
    glBufferSubData(GL_ARRAY_BUFFER, 0, g_text_count * sizeof(TextVert), g_text_verts);
    shader_bind(&g_text_shader);
    if (g_text_loc_screen >= 0) glUniform2f(g_text_loc_screen, (f32)sw, (f32)sh);
    glActiveTexture(GL_TEXTURE0);
    glBindTexture(GL_TEXTURE_2D, g_font_texture);
    if (g_text_loc_texture >= 0) glUniform1i(g_text_loc_texture, 0);
    glBindVertexArray(g_text_vao);
    glDrawArrays(GL_TRIANGLES, 0, g_text_count);
    glBindVertexArray(0);
    glDisable(GL_BLEND);
    glEnable(GL_DEPTH_TEST);
    g_text_count = 0;
}

void debug_line(const Vec3& a, const Vec3& b, const Vec3& color) {
    if (g_line_count + 2 > 8192) return;
    LineVert* v = &g_line_verts[g_line_count];
    v[0] = {a.x, a.y, a.z, color.x, color.y, color.z};
    v[1] = {b.x, b.y, b.z, color.x, color.y, color.z};
    g_line_count += 2;
}

void debug_box(const AABB& box, const Vec3& color) {
    Vec3 mn = box.min, mx = box.max;
    debug_line({mn.x,mn.y,mn.z}, {mx.x,mn.y,mn.z}, color);
    debug_line({mx.x,mn.y,mn.z}, {mx.x,mn.y,mx.z}, color);
    debug_line({mx.x,mn.y,mx.z}, {mn.x,mn.y,mx.z}, color);
    debug_line({mn.x,mn.y,mx.z}, {mn.x,mn.y,mn.z}, color);
    debug_line({mn.x,mx.y,mn.z}, {mx.x,mx.y,mn.z}, color);
    debug_line({mx.x,mx.y,mn.z}, {mx.x,mx.y,mx.z}, color);
    debug_line({mx.x,mx.y,mx.z}, {mn.x,mx.y,mx.z}, color);
    debug_line({mn.x,mx.y,mx.z}, {mn.x,mx.y,mn.z}, color);
    debug_line({mn.x,mn.y,mn.z}, {mn.x,mx.y,mn.z}, color);
    debug_line({mx.x,mn.y,mn.z}, {mx.x,mx.y,mn.z}, color);
    debug_line({mx.x,mn.y,mx.z}, {mx.x,mx.y,mx.z}, color);
    debug_line({mn.x,mn.y,mx.z}, {mn.x,mx.y,mx.z}, color);
}

void debug_wire_box(const Vec3& center, const Vec3& size, const Vec3& color) {
    Vec3 half = size * 0.5f;
    debug_box({center - half, center + half}, color);
}

void debug_lines_flush(const Camera* camera, i32 screen_w, i32 screen_h) {
    if (g_line_count == 0) return;
    glDisable(GL_DEPTH_TEST);
    glLineWidth(1.0f);
    glBindBuffer(GL_ARRAY_BUFFER, g_line_vbo);
    glBufferSubData(GL_ARRAY_BUFFER, 0, g_line_count * sizeof(LineVert), g_line_verts);
    shader_bind(&g_line_shader);
    Mat4 view = camera_view_matrix(camera);
    Mat4 proj = camera_projection_matrix(camera, (f32)screen_w / (f32)screen_h);
    Mat4 vp = mat4_multiply(proj, view);
    if (g_line_loc_viewproj >= 0) glUniformMatrix4fv(g_line_loc_viewproj, 1, GL_FALSE, vp.m);
    glBindVertexArray(g_line_vao);
    glDrawArrays(GL_LINES, 0, g_line_count);
    glBindVertexArray(0);
    glEnable(GL_DEPTH_TEST);
    g_line_count = 0;
}

}
